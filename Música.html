<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√öSICA</title>
    <link rel="stylesheet" href="css/General.css">
    <link rel="stylesheet" href="css/Reproductor_Audio.css">
    <link rel="stylesheet" href="css/Cancion.css">
    <link rel="stylesheet" href="css/Archivo.css">
    <link rel="stylesheet" href="css/CrearLista.css">
    
    <script src="js/General.js" defer></script>
    <script src="js/Paginaci√≥n.js" defer></script>
    <script src="js/Botones.js" defer></script>
    <script src="js/Archivo.js" defer></script>
    <script src="js/CrearLista.js" defer></script>
</head>
<body>
    <h1>M√öSICA</h1>
    <div id="containerAudio">
        <div id="reproduccion">
            <div>
                <h2 id="tituloAudio"></h2>
            </div>
            <div>
                <audio controls id="audio"><source src="../../Music/A Million Gruesome Ways To Die.mp3"></audio>
            </div>
            <div id="div_btn">
                <button title="Reiniciar" onclick="audioReiniciar()" class="btn_controls">‚Ü©Ô∏é</button>
                <button title="Bucle" onclick="audioBucle()" id="btn_bucle" class="btn_controls">‚Üª</button>
                <button title="Pausar" onclick="audioPlay()" id="btn_Play" class="btn_controls">‚ùô‚ùô</buuton>
                <button title="Activar Continuar" onclick="audioContinue()" id="btn_Continuar" class="btn_controls">‚û§</buuton>
            </div>
            <div id="infoAudio">
                <span id="numeroCancion">0</span> / <span id="paginaCancion">0</span>
            </div>
        </div>

        <div id="containerBotones">
            <div id="btn_botones">
                <button onclick="reproducirAudio(95)" class="btn_musica">Inmortal</button>
            </div>

            <div id="cambioCacnion">
                <button title="Anterior Canci√≥n" onclick="cambiarAudio(1)" class="btn_controls">‚èÆ</button>
                <button title="Siguiente Canci√≥n" onclick="cambiarAudio(2)" class="btn_controls">‚è≠</button>
            </div>
            
            <div id="paginacion">
                <button title="Anterior Pag√≠na" class="btn_controls" onclick="paginaci√≥n(0)">‚≠Ö</button>
                <div id="div_paginaActual"><span id="paginaActual">1</span></div>
                <button title="Proxima Pag√≠na" class="btn_controls" onclick="paginaci√≥n(1)">‚≠Ü</button>
            </div>
        </div>
    </div>

    <button onclick="mostrarSubirArchivo()">Subir Audios</button>
    <div id="alertaArchivo">
        <div id="contenidoArchivo">
            <h2>Subir Audios desde Carpeta</h2>
            <button id="btn-cargar">Cargar audios</button>
            <input type="file" id="input-folder" webkitdirectory multiple hidden><br><br>
            <button onclick="ocultarSubirArchivo()">Cerrar</button>
        </div>
    </div>
    <button onclick="mostrarCrearLista()">Crear Lista</button>
    <div id="alertaCrearLista">
        <div id="contenidoCrearLista">
            <h2>Crear Lista</h2>
            <div id="div_CrearLista">
                <div class="divsCrearLista" id="ListaCreadas">
                    <div id="ListasCreada">
                        <div class="divSpaceBetween">
                            <button onclick="CargarMusicaLista(0)">A</button>
                            <div>
                                <button onclick="EliminarLista(0)">üóë</button>
                                <button onclick="EditarLista(0)">‚öôÔ∏é</button>
                            </div>
                        </div>
                    </div>
                    <button onclick="NuevaLista()">+</button>
                </div>
                <div class="divsCrearLista" id="divBuscador">
                    <input type="text" id="buscador" placeholder="Escribe para buscar..." autocomplete="off">
                    <div id="resultados"></div>
                </div>
                <div class="divsCrearLista" id="CrearLista">
                    <div id="divarribaCrearLista">
                        T√≠tulo: <input type="text" maxlength="50" id="tituloLista">
                    </div>
                    <div id="CancionA√±adida"></div>
                    <div>
                        <button onclick="CancelarNuevaLista()">Cancelar</button>
                        <button onclick="GuardarLista()" id="GuardarLista">Guardar</button>
                        <div id="errorLista"></div>
                    </div>
                </div>
            </div>
            <button onclick="ocultarCrearLista()">Cerrar</button>
        </div>
    </div>



    <script>// Subir audios desde carpeta y guardar en localStorage
        // Cargar lista al iniciar
        Lista = JSON.parse(localStorage.getItem("Lista")) || [];

        document.getElementById("btn-cargar").addEventListener("click", () => {
            document.getElementById("input-folder").click();
        });

        document.getElementById("input-folder").addEventListener("change", async (event) => {
            const files = [...event.target.files];

            const audioFiles = files.filter(file => file.type.startsWith("audio/"));

            const audioArray = [];

            for (const file of audioFiles) {
                const objectURL = URL.createObjectURL(file);
                const duration = await obtenerDuracion(objectURL);

                const modifiedName = file.name.replace(/\.[^.]+$/, "") // Eliminar la extensi√≥n
                                              .replace(/  /g, " / ")  // Reemplazar "  " por " / "
                                              .replace(/_ /g, ": ");

                audioArray.push({
                    nombre: file.name.replace(/\.[^.]+$/, "").replace(/  /g, " / ").replace(/_ /g, ": "),
                    src: "../" + file.name,
                });

                URL.revokeObjectURL(objectURL);
            }

            // üëâ Guardar en localStorage
            localStorage.setItem("Lista", JSON.stringify(audioArray));
            alert("Array generado y guardado en localStorage.");
        });

        function obtenerDuracion(url) {
            return new Promise(resolve => {
                const audio = document.createElement("audio");
                audio.src = url;
                audio.addEventListener("loadedmetadata", () => {
                    resolve(audio.duration);
                });
            });
        }
    </script>
    <script>// Poner siguiente canci√≥n autom√°ticamente
        // Detectar cuando termina el audio
        document.getElementById("audio").addEventListener("ended", function () {
            // Si el bucle est√° activado o nop esta activo la siguiente canci√≥n, no avanzar a la siguiente
            if (btn_Lista.Bucle === "on" || btn_Lista.Siguiente === "off") return;

            // Si NO es la √∫ltima canci√≥n, avanzar
            if (btn_Lista.N_Cancion < Lista.length - 1) {
                btn_Lista.N_Cancion++;

                // Control de paginaci√≥n autom√°tica si cambia de p√°gina
                if (btn_Lista.N_Cancion + 1 > btn_Lista.Max) {
                    paginaci√≥n(1);
                }

                reproducirAudio(btn_Lista.N_Cancion);
            }
            else {
                // Si lleg√≥ a la √∫ltima canci√≥n
                btn_Lista.Play = "off";
                document.getElementById("btn_Play").innerText = "‚ñ∂";
            }
        });

    </script>
    <script>//Buscador para crear Lista
        // Funci√≥n que se ejecuta al hacer clic
        function seleccionarElemento(index) {
            const item = Lista[index];
            alert("Seleccionaste: " + item.nombre + "\n√çndice: " + index);
        }

        // ------------------------------------
        // Buscador con botones
        // ------------------------------------
        document.getElementById("buscador").addEventListener("input", function() {
            const texto = this.value.toLowerCase();
            const contenedor = document.getElementById("resultados");
            contenedor.innerHTML = "";

            if (texto.trim() === "") return;

            // Filtrado con √≠ndice real del array
            const filtrados = Lista
                .map((obj, i) => ({ obj, index: i })) // guardamos el √≠ndice
                .filter(item => item.obj.nombre.toLowerCase().includes(texto))
                .slice(0, 40);

            filtrados.forEach(item => {
                const btn = document.createElement("button");
                btn.textContent = item.obj.nombre;

                // onclick enviando el √≠ndice real
                btn.onclick = () => A√±adirCancion(item.index);

                contenedor.appendChild(btn);
            });
        });
    </script>
</body>
</html>